<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Movie</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
<div id="header-placeholder"></div>

<div class="container">
    <div class="header">
        <img class="poster" id="poster" src="" alt="–ü–æ—Å—Ç–µ—Ä —Ñ–∏–ª—å–º–∞">
        <div class="text-info">
            <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
            <div class="year" id="year"></div>
            <div class="description" id="description"></div>
            <div class="rating" id="meanRating"></div>
            <!-- –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–∏—Ç—å -->
            <button id="deleteButton" class="header-btn" style="background-color: #dc3545; margin-top: 10px;">
                –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º
            </button>
        </div>
    </div>
    <div class="reviews" id="reviews">
        <h2>–û—Ç–∑—ã–≤—ã</h2>
        <div id="reviewsList"></div>
    </div>
</div>

<script>
    // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");

    const deleteButton = document.getElementById('deleteButton');
    deleteButton.style.display = movieId ? 'inline-block' : 'none';

    if (!movieId) {
        document.getElementById("title").textContent = "ID —Ñ–∏–ª—å–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL";
    } else {
        fetch(`/movie/${movieId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("–§–∏–ª—å–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("title").textContent = data.title;
                document.getElementById("year").textContent = "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: " + data.year;
                document.getElementById("description").textContent = data.description;
                document.getElementById("poster").src = data.posterUrl || "/static/images/no-image.png";

                let sum = 0;
                data.reviews.forEach(r => sum += r.rating);
                const meanRating = (data.reviews.length > 0)
                    ? (sum / data.reviews.length).toFixed(2)
                    : "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫";

                document.getElementById("meanRating").textContent = "‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: " + meanRating;

                const reviewsList = document.getElementById("reviewsList");
                data.reviews.forEach(review => {
                    const div = document.createElement("div");
                    div.className = "review";
                    div.innerHTML = `
            <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${review.userId}</strong>:
            <span>–æ—Ü–µ–Ω–∫–∞ ${review.rating}</span>
          `;
                    reviewsList.appendChild(div);
                });
            })
            .catch(error => {
                document.getElementById("title").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–∞ üò¢";
                console.error("–û—à–∏–±–∫–∞:", error);
            });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –£–¥–∞–ª–∏—Ç—å
    deleteButton.addEventListener('click', () => {
        if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?")) {
            fetch(`/movie?id=${movieId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        alert('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                        window.location.href = '/movies.html';
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                });
        }
    });

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–ø–∫–∏
    fetch('/fragments/header.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('header-placeholder').innerHTML = html;
        })
        .catch(error => {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å header:', error);
        });
</script>
</body>
</html>
