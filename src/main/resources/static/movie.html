<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Movie</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
<div id="header-placeholder"></div>

<div class="container">
    <div class="header">
        <img class="poster" id="poster" src="" alt="–ü–æ—Å—Ç–µ—Ä —Ñ–∏–ª—å–º–∞">
        <div class="text-info">
            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <button id="editTitleBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">‚úèÔ∏è</button>
                </div>
                <div id="editTitleForm" class="edit-form">
                    <input type="text" id="newTitleInput">
                    <button id="saveTitleBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <div class="year" id="year">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</div>
                    <button id="editYearBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ–¥">‚úèÔ∏è</button>
                </div>
                <div id="editYearForm" class="edit-form">
                    <input type="number" id="newYearInput">
                    <button id="saveYearBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <div class="description" id="description"></div>
                    <button id="editDescriptionBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ">‚úèÔ∏è</button>
                </div>
                <div id="editDescriptionForm" class="edit-form">
                    <textarea id="newDescriptionInput" rows="3"></textarea>
                    <button id="saveDescriptionBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ -->
            <div class="rating" id="meanRating"></div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <a id="updateLink" class="header-btn add-button">–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å–º</a>
                <button id="deleteButton" class="header-btn" style="background-color: #dc3545;">
                    –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º
                </button>
            </div>
        </div>
    </div>

    <div class="reviews" id="reviews">
        <h2>–û—Ç–∑—ã–≤—ã</h2>
        <div id="reviewsList"></div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞ -->
    <div class="review-form">
        <h2>–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</h2>
        <label for="ratingInput">–û—Ü–µ–Ω–∫–∞ (1‚Äì10):</label>
        <input type="number" id="ratingInput" min="1" max="10" required>
        <label for="commentInput">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π:</label>
        <textarea id="commentInput" rows="3"></textarea>
        <button id="submitReviewBtn" class="header-btn add-button" style="margin-top:10px;">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
    </div>
</div>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");

    const deleteButton = document.getElementById('deleteButton');
    deleteButton.style.display = movieId ? 'inline-block' : 'none';

    if (!movieId) {
        document.getElementById("title").textContent = "ID —Ñ–∏–ª—å–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL";
    } else {
        fetch(`/movie/${movieId}`)
            .then(response => {
                if (!response.ok) throw new Error("–§–∏–ª—å–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
                return response.json();
            })
            .then(data => {
                document.getElementById("title").textContent = data.title;
                document.getElementById("year").textContent = "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: " + data.year;
                document.getElementById("description").textContent = data.description;
                document.getElementById("poster").src = data.posterUrl || "/static/images/no-image.png";

                let sum = 0;
                data.reviews.forEach(r => sum += r.rating);
                const meanRating = (data.reviews.length > 0)
                    ? (sum / data.reviews.length).toFixed(2)
                    : "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫";

                document.getElementById("meanRating").textContent = "‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: " + meanRating;

                const reviewsList = document.getElementById("reviewsList");
                data.reviews.forEach(review => {
                    const div = document.createElement("div");
                    div.className = "review";
                    div.innerHTML = `
        <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${review.userId}</strong>:
        <span>–û—Ü–µ–Ω–∫–∞ ${review.rating}</span>
        <span>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${review.text}</span>
        <button class="delete-review-btn" style="
            margin-left: 10px;
            background-color: #dc3545;
            border: none;
            color: white;
            padding: 3px 7px;
            border-radius: 3px;
            cursor: pointer;
        ">–£–¥–∞–ª–∏—Ç—å</button>
    `;

                    const deleteBtn = div.querySelector(".delete-review-btn");
                    deleteBtn.addEventListener("click", () => {
                        if (confirm("–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç –æ—Ç–∑—ã–≤?")) {
                            fetch(`/review/delete/${review.id}`, {
                                method: "DELETE"
                            })
                                .then(response => {
                                    if (response.ok) {
                                        alert("–û—Ç–∑—ã–≤ —É–¥–∞–ª—ë–Ω");
                                        div.remove(); // –£–±–∏—Ä–∞–µ–º –∏–∑ DOM
                                    } else {
                                        alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞");
                                    }
                                })
                                .catch(error => {
                                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –æ—Ç–∑—ã–≤–∞:", error);
                                    alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
                                });
                        }
                    });

                    reviewsList.appendChild(div);
                });
            })
            .catch(error => {
                document.getElementById("title").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–∞ üò¢";
                console.error("–û—à–∏–±–∫–∞:", error);
            });
    }

    deleteButton.addEventListener('click', () => {
        if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?")) {
            fetch(`/movie?id=${movieId}`, { method: 'DELETE' })
                .then(response => {
                    if (response.ok) {
                        alert('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                        window.location.href = '/movies.html';
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                });
        }
    });

    const updateLink = document.getElementById('updateLink');
    updateLink.href = `/update.html?id=${movieId}`;

    fetch('/fragments/header.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('header-placeholder').innerHTML = html;
        })
        .catch(error => {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å header:', error);
        });

    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞
    const submitReviewBtn = document.getElementById('submitReviewBtn');
    submitReviewBtn.addEventListener('click', () => {
        const rating = parseInt(document.getElementById('ratingInput').value);
        const comment = document.getElementById('commentInput').value.trim();

        if (isNaN(rating) || rating < 1 || rating > 10) {
            alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –æ—Ü–µ–Ω–∫—É –æ—Ç 1 –¥–æ 10");
            return;
        }

        fetch(`/review/create/${movieId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                rating: rating,
                userId:2,
                text: comment
            })
        })
            .then(response => {
                if (response.ok) {
                    alert("–û—Ç–∑—ã–≤ –¥–æ–±–∞–≤–ª–µ–Ω!");
                    location.reload();
                } else {
                    alert("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞");
                }
            })
            .catch(error => {
                console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞:", error);
                alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏");
            });
    });
</script>
</body>
</html>
