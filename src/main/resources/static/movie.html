<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>Movie</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon" href="/favicon.ico" type="image/x-icon">
</head>
<body>
<div id="header-placeholder"></div>

<div class="container">
    <div class="header">
        <img class="poster" id="poster" src="" alt="–ü–æ—Å—Ç–µ—Ä —Ñ–∏–ª—å–º–∞">
        <div class="text-info">
            <!-- –ù–∞–∑–≤–∞–Ω–∏–µ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <h1 id="title">–ó–∞–≥—Ä—É–∑–∫–∞...</h1>
                    <button id="editTitleBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ">‚úèÔ∏è</button>
                </div>
                <div id="editTitleForm" class="edit-form">
                    <input type="text" id="newTitleInput">
                    <button id="saveTitleBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –ì–æ–¥ –≤—ã–ø—É—Å–∫–∞ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <div class="year" id="year">–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞:</div>
                    <button id="editYearBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –≥–æ–¥">‚úèÔ∏è</button>
                </div>
                <div id="editYearForm" class="edit-form">
                    <input type="number" id="newYearInput">
                    <button id="saveYearBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –û–ø–∏—Å–∞–Ω–∏–µ -->
            <div>
                <div style="display: flex; align-items: center;">
                    <div class="description" id="description"></div>
                    <button id="editDescriptionBtn" class="edit-btn" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ">‚úèÔ∏è</button>
                </div>
                <div id="editDescriptionForm" class="edit-form">
                    <textarea id="newDescriptionInput" rows="3"></textarea>
                    <button id="saveDescriptionBtn" class="header-btn add-button">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>

            <!-- –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞ -->
            <div class="rating" id="meanRating"></div>

            <!-- –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div style="margin-top: 10px; display: flex; gap: 10px;">
                <a id="updateLink" class="header-btn add-button">–û–±–Ω–æ–≤–∏—Ç—å —Ñ–∏–ª—å–º</a>
                <button id="deleteButton" class="header-btn" style="background-color: #dc3545;">
                    –£–¥–∞–ª–∏—Ç—å —Ñ–∏–ª—å–º
                </button>
            </div>
        </div>

    </div>
    <div class="reviews" id="reviews">
        <h2>–û—Ç–∑—ã–≤—ã</h2>
        <div id="reviewsList"></div>
    </div>
</div>

<script>
    // –ü–æ–ª—É—á–∞–µ–º ID –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const movieId = urlParams.get("id");

    const deleteButton = document.getElementById('deleteButton');
    deleteButton.style.display = movieId ? 'inline-block' : 'none';

    if (!movieId) {
        document.getElementById("title").textContent = "ID —Ñ–∏–ª—å–º–∞ –Ω–µ —É–∫–∞–∑–∞–Ω –≤ URL";
    } else {
        fetch(`/movie/${movieId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error("–§–∏–ª—å–º –Ω–µ –Ω–∞–π–¥–µ–Ω");
                }
                return response.json();
            })
            .then(data => {
                document.getElementById("title").textContent = data.title;
                document.getElementById("year").textContent = "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: " + data.year;
                document.getElementById("description").textContent = data.description;
                document.getElementById("poster").src = data.posterUrl || "/static/images/no-image.png";

                let sum = 0;
                data.reviews.forEach(r => sum += r.rating);
                const meanRating = (data.reviews.length > 0)
                    ? (sum / data.reviews.length).toFixed(2)
                    : "–ù–µ—Ç –æ—Ü–µ–Ω–æ–∫";

                document.getElementById("meanRating").textContent = "‚≠ê –°—Ä–µ–¥–Ω—è—è –æ—Ü–µ–Ω–∫–∞: " + meanRating;

                const reviewsList = document.getElementById("reviewsList");
                data.reviews.forEach(review => {
                    const div = document.createElement("div");
                    div.className = "review";
                    div.innerHTML = `
                    <strong>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å #${review.userId}</strong>:
                    <span>–æ—Ü–µ–Ω–∫–∞ ${review.rating}</span>
                `;
                    reviewsList.appendChild(div);
                });
            })
            .catch(error => {
                document.getElementById("title").textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∏–ª—å–º–∞ üò¢";
                console.error("–û—à–∏–±–∫–∞:", error);
            });
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –£–¥–∞–ª–∏—Ç—å
    deleteButton.addEventListener('click', () => {
        if (confirm("–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Ñ–∏–ª—å–º?")) {
            fetch(`/movie?id=${movieId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (response.ok) {
                        alert('–§–∏–ª—å–º —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!');
                        window.location.href = '/movies.html';
                    } else {
                        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                    }
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏:', error);
                    alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Ñ–∏–ª—å–º–∞');
                });
        }
    });

    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Å—ã–ª–∫—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    const updateLink = document.getElementById('updateLink');
    updateLink.href = `/update.html?id=${movieId}`;

    // –ó–∞–≥—Ä—É–∑–∫–∞ —à–∞–ø–∫–∏
    fetch('/fragments/header.html')
        .then(response => response.text())
        .then(html => {
            document.getElementById('header-placeholder').innerHTML = html;
        })
        .catch(error => {
            console.error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å header:', error);
        });


    //patch –æ—Ç–¥–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π


    // –ù–∞–∑–≤–∞–Ω–∏–µ
    editTitleBtn.addEventListener("click", () => {
        newTitleInput.value = document.getElementById("title").textContent;
        editTitleForm.style.display = "block";
    });
    saveTitleBtn.addEventListener("click", () => {
        const newTitle = newTitleInput.value.trim();
        fetch(`/movie/${movieId}/title`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ title: newTitle })
        })
            .then(r => {
                if (r.ok) {
                    document.getElementById("title").textContent = newTitle;
                    editTitleForm.style.display = "none";
                    alert("–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
                } else alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            });
    });

    // –ì–æ–¥
    editYearBtn.addEventListener("click", () => {
        const text = document.getElementById("year").textContent;
        const yearValue = text.match(/\d+/) ? text.match(/\d+/)[0] : "";
        newYearInput.value = yearValue;
        editYearForm.style.display = "block";
    });
    saveYearBtn.addEventListener("click", () => {
        const newYear = parseInt(newYearInput.value);
        fetch(`/movie/${movieId}/year`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ year: newYear })
        })
            .then(r => {
                if (r.ok) {
                    document.getElementById("year").textContent = "–ì–æ–¥ –≤—ã–ø—É—Å–∫–∞: " + newYear;
                    editYearForm.style.display = "none";
                    alert("–ì–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω!");
                } else alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            });
    });

    // –û–ø–∏—Å–∞–Ω–∏–µ
    editDescriptionBtn.addEventListener("click", () => {
        newDescriptionInput.value = document.getElementById("description").textContent;
        editDescriptionForm.style.display = "block";
    });
    saveDescriptionBtn.addEventListener("click", () => {
        const newDesc = newDescriptionInput.value.trim();
        fetch(`/movie/${movieId}/description`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ description: newDesc })
        })
            .then(r => {
                if (r.ok) {
                    document.getElementById("description").textContent = newDesc;
                    editDescriptionForm.style.display = "none";
                    alert("–û–ø–∏—Å–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ!");
                } else alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            });
    });

    // –ü–æ—Å—Ç–µ—Ä
    editPosterBtn.addEventListener("click", () => {
        newPosterInput.value = document.getElementById("poster").src;
        editPosterForm.style.display = "block";
    });
    savePosterBtn.addEventListener("click", () => {
        const newPoster = newPosterInput.value.trim();
        fetch(`/movie/${movieId}/poster`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ posterUrl: newPoster })
        })
            .then(r => {
                if (r.ok) {
                    document.getElementById("poster").src = newPoster;
                    editPosterForm.style.display = "none";
                    alert("–ü–æ—Å—Ç–µ—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!");
                } else alert("–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è");
            });
    });

</script>
</body>
</html>
